<style>
    .shortcut_menu .badge {
        position: absolute;
        right: 18px;
        top: 0;
    }
</style>
@using Jurassic.WebSchedule;
@*在首页右上角显示的事件提醒*@
@using Jurassic.WebSchedule;
<a class="mini-button " iconCls="icon-new-message" plain="true" href="javascript:void(0)" id="alertBox-toggle" onclick="onClick" tooltip="@JStr.Message">
    <span class="badge badge-righttop" id="alertsNum"></span>
</a>
@*消息提醒列表 wang 2016-3-19*@
<div id="alertBox" class="col-xs-6 col-md-4 col-lg-3 frame-clicktoggle" style="position:absolute; top:54px; right:0px; height:230px;display:none;z-index:1000">
    <form>
        <div>
            <a class="mini-button frame-submit" plain="true">@SStr.MessageManager</a>
            <a class="mini-button frame-submit" plain="true">@SStr.ReadAll</a>
            <a class="mini-button frame-submit" plain="true">@SStr.ClearAll</a>
        </div>
        <div id="alertGrid" class="mini-datagrid" style="width:100%;height:180px"
             url="@Url.Action("GetAlerts", "Schedule")" pagesize="5" allowresize="true" multiselect="true" showcolumns="false" showpagesize="false" showpageindex="false"
             onrowdblclick="edit" showemptytext="true" emptytext="@SStr.NoMessage">
            <div property="columns">
                <div field="title" headeralign="center" width="70%" allowsort="true">@JStr.Title</div>
                <div field="start" headeralign="center" width="30%" dateformat="MM-dd HH:mm" allowsort="true">@JStr.StartTime</div>
            </div>
        </div>
    </form>
</div>
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<script type="text/javascript">
    $(function () {
        var alertBox = $('#alertBox');
        $('body').append(alertBox);

        //更新左侧导航栏树结点上的标记
        function updateLeftMenuMarks() {
            $.newGET("@Url.Action("GetExtInfos", "Schedule")", function (extInfos) {
                if (!extInfos) return;
                //遍历outlookbar中的所有树中的结点
                $('#nav_left .mini-tree').each(function () {
                    var treeId = this.id;
                    var tree = mini.get(treeId);
                    if (!tree) return;
                    for (var i in extInfos) {
                        var m = extInfos[i];
                        var node = tree.getNode(m.MenuId);
                        if (!node) continue;
                        var nodeText = (node[tree.getTextField()] || "").split('<')[0];
                        if (m.BadgeText) {
                            nodeText += "<small class='badge'>" + m.BadgeText + "</small>";
                        }
                        tree.setNodeText(node, nodeText);
                    }
                });

                var bar = mini.get("nav_leftMenuBar");

                //遍历outlookbar的面板标题
                for (var i in extInfos) {
                    var m = extInfos[i];
                    var grp = bar.getGroup(m.MenuId);
                    if (!grp) continue;
                    var grpTitle = (grp.title || "").split('<')[0];
                    if (m.BadgeText && m.BadgeText != "0") {
                        grpTitle += "<small class='badge'>" + m.BadgeText + "</small>";
                    }
                    bar.updateGroup(grp, { title: grpTitle });
                    extInfos.pop(m);
                }
                //window.ExtMenuInfo = extInfos;
                ////用于其他地方扩展此方法处理剩余的MenuInfo
                //if (iframe && iframe.$) {
                //    iframe.$('body').trigger("updateMenu", extInfos);
                //}
            });
        }

        function showAlertsNum(e) {
            $('#alertsNum').text(e.total);
            if (e.total) {
                $('#alertsNum').show();
            }
            else {
                $('#alertsNum').hide();
            }
            updateLeftMenuMarks();
        }

        function processEvents(e) {
            //当该记录明确标识有处理的URL
            if (e.record.url) {
                //下面主要是提交一下表示已读
                $.post('@Url.Action("Read", "Schedule")' + "?caId=" + e.record.caId);
                //到实际处理页
                iframe.contentWindow.location.href = e.record.url;
            }
            else {
                mini.open({
                    title: '日程',
                    url: '@Url.Action("Read", "Schedule")' + "?caId=" + e.record.caId,
                    //showModal: false,
                    width: 600,
                    height: 440,
                    ondestroy: showAlertsNum
                });
            }
        }

        var alertGrid = mini.get('#alertGrid');
        alertGrid.on("load", showAlertsNum);
        alertGrid.on("rowclick", processEvents);

        //错开页面请求高峰期
        setTimeout(function () { alertGrid.load() }, 3000);

        //暂时用轮询
        //setInterval(alertGrid.load, 30000);

        $(iframe).load(function () {
            $(iframe.contentDocument).click(function () {
                if (alertBox.is(':visible')) {
                    alertGrid.reload();
                    alertBox.hide();
                }
            });
        });

        //使用signalR的定时提醒
        // Declare a proxy to reference the hub.
        var procHub = $.connection.processerHub;

        function init() {
            procHub.server.addGroup(@User.Identity.GetUserId());
        }

        // Add a client-side hub method that the server will call
        procHub.client.alert = function (alertMessage) {
            if (alertMessage != null) {
                if (iframe && iframe.contentWindow.$) {
                    iframe.contentWindow.$('body').trigger('onAlert', alertMessage);
                }
            }
            else {
                alertGrid.reload();
            }
        }
        // Start the connection
        $.connection.hub.start().done(init);

        $.regButton({
            text: "@SStr.MessageManager",
            noSubmit: function () {
                parent.iframe.contentWindow.location.href = "@Url.Action("MessageManager", "Schedule")";
            }
        });

        $.regButton({
            text: "@SStr.ClearAll",
            beforeSubmit: function (ajax) {
                ajax.url = "@Url.Action("Clear", "Schedule")";
                ajax.method = "POST";
            }
        });

        $.regButton({
            text: "@SStr.ReadAll",
            beforeSubmit: function (ajax) {
                ajax.url = "@Url.Action("ReadAll", "Schedule")";
                ajax.method = "POST";
            }
        });

        $('form').bind('afterSubmit', function () {
            alertGrid.reload();
        });
    });

</script>