@{
    ViewBag.Title = "SignalRProcesserFactory Demo";
}
<h3>SignalRProcesserFactory Demo</h3>
<div class="mini-panel" title="说明"
     style="width:100%">
    <p>
        本框架使用队列来处理SignalR发布的消息。<br />
        在控制器中，定义了两个简单的Processer,'简单抓取'和'简单延时', 并添加了若干元素形成处理队列，
        并实时显示队列中处理情况。<br />
        当按下Ctrl+N新建一个页面时，两个页面的进度条会同步显示进度。<br />
    </p>
</div>
<br />
<div id="grid1" class="mini-datagrid" style="width:100%;"
     showpager="false" allowresize="true">
    <div property="columns">
        <div type="indexcolumn"></div>
        <div field="Name" headeralign="center" allowsort="true">Processer Name</div>
        <div renderer="onProgressRender" field="ProcessedPercent" headeralign="center" allowsort="true">Percent</div>
        <div renderer="onActionRenderer" headeralign="center" allowsort="true">Operation</div>
    </div>
</div>
<br />
<div class="col-md-6">
    <div id="broadcastShow" style="border:1px solid #aaa;width:100%;height:80px;overflow:auto">
    </div>
    <input type="text" class="mini-textbox" id="broadcastMsg" width="300" />
    <a href="#" class="mini-button frame-submit">发送广播消息</a>
</div>


<div class="mini-panel" style="width:100%" title="菜单/按钮旁边的数字"
    <label>点击此按钮，从服务端获取提醒的数字, 显示在本页</label><br />
    <a class="mini-button frame-submit" id="messageNumDemo">当前页的提醒</a>
<br />
    <label>点击此按钮， 从服务端获取提醒的数字，显示在左侧菜单</label><br />
    <a class="mini-button frame-submit" id="alertFullDemo">左侧菜单的提醒</a>
</div>



<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<!--Add script to update the page and send messages.-->
<script type="text/javascript">

    mini.parse();
    var grid = mini.get("#grid1");

    $(function () {
        // Declare a proxy to reference the hub.
        var procHub = $.connection.processerHub;

        function init() {
            procHub.server.getAllProcessers().done(function (procs) {
                procHub.server.addGroup("Admin");
                grid.loadData(procs);
            });
        }

        // Add a client-side hub method that the server will call
        procHub.client.reportProgress = function (proc) {
            var row = grid.findRow(function (row) {
                if (row.Name == proc.Name) return true;
            });

            grid.updateRow(row, proc);
        }

        procHub.client.broadcast = function (msg) {
            $('#broadcastShow').append("<p>" + msg + "</p>");
            $('#broadcastShow')[0].scrollTop = 1000000;
        };

        // Start the connection
        $.connection.hub.start().done(init);
    });

    function onActionRenderer(e) {
        var grid = e.sender;
        var record = e.record;
        var uid = record.Name;
        var rowIndex = e.rowIndex;

        var s = '<a href="javascript:start(\'' + uid + '\')">Start</a>';
        return s;
    }

    function onProgressRender(e) {
        var grid = e.sender;
        var record = e.record;
        var pct = record.ProcessedPercent;
        var uid = record.Id;
        var rowIndex = e.rowIndex;

        var s = '<div class="mini-progressbar" style="border-width: 0px;"><div class="mini-progressbar-border"><div class="mini-progressbar-bar" style="width: ' + pct + '%;"></div><div class="mini-progressbar-text">' + pct + '%</div></div></div>';
        return s;
    }

    function start(uid) {
        $.newGET('@Url.Action("Start")', { processerName: uid });
    }

    $.regButton({
        text: '发送广播消息',
        beforeSubmit: function (ajax) {
            ajax.url = '@Url.Action("Broadcast")',
            ajax.data = { text: mini.get('#broadcastMsg').getValue() };
            mini.get('#broadcastMsg').setValue('');
        }
    });


    //自动更新“提醒标签”的数字
    $('body').on("onAlert", function (e, alertMessage) {
        var btn = mini.get("messageNumDemo");
        var txt = btn.getText();
        txt = txt.split('<')[0];
        if (alertMessage) {
            txt = txt + "<small class='badge'>" + alertMessage + "</small>";
        }
        btn.setText(txt);
    });

    $.regButton({
        id: 'messageNumDemo',
        beforeSubmit: function (ajax) {
            ajax.url = '@Url.Action("AlertFast")';
            //如果此处换成另一个登录用户Id，将在其界面上显示
            ajax.data = { userId: '@User.Identity.GetUserId()' };
            ajax.validate = false;
        }
    });

    $.regButton({
        id: 'alertFullDemo',
        beforeSubmit: function (ajax) {
            ajax.url = '@Url.Action("AlertFullFast")';
            //如果此处换成另一个登录用户Id，将在其界面上显示
            ajax.data = { userId: '@User.Identity.GetUserId()' };
            ajax.validate = false;
        }
    });

</script>
